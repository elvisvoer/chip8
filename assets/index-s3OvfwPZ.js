var b=Object.defineProperty;var m=(h,e,i)=>e in h?b(h,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):h[e]=i;var n=(h,e,i)=>(m(h,typeof e!="symbol"?e+"":e,i),i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function i(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(s){if(s.ep)return;s.ep=!0;const r=i(s);fetch(s.href,r)}})();const l=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];class w{constructor(e=4*1024){n(this,"cpu");n(this,"ram");n(this,"fb");n(this,"hires",!1);n(this,"waitingInput",!1);n(this,"waitReg",-1);n(this,"ready",!1);n(this,"k",new Set);this.memSize=e,this.reset()}get framebuffer(){return this.fb}get framebufferHeight(){return this.hires?64:32}get framebufferWidth(){return this.hires?128:64}load(e,i=512){if(this.ready=!1,this.reset(),e.length+i>this.ram.length)throw new Error("Failed to load - ROM too large.");for(let t=0;t<e.length;t+=1)this.ram[i+t]=e[t];this.cpu.pc=i,this.ready=!0}tick(){if(!this.ready||this.waitingInput)return;if(this.cpu.pc>this.ram.length)throw new Error("Attempt to read outside RAM bounds.");const e=this.ram[this.cpu.pc]<<8|this.ram[this.cpu.pc+1];this.cpu.pc+=2,this.executeOp(e)}updateTimers(){this.cpu.dt>0&&this.cpu.dt--,this.cpu.st>0&&this.cpu.st--}setKeyDown(e){this.k.add(e),this.waitingInput&&(this.cpu.v[this.waitReg]=e&255,this.waitingInput=!1)}setKeyUp(e){this.k.delete(e)}clearFramebuffer(){this.fb=new Uint8Array(this.framebufferHeight*this.framebufferWidth)}draw(e,i,t){this.cpu.v[15]=0;for(let s=0;s<t;s++)for(let r=0;r<8;r++){const a=(e+r)%this.framebufferWidth+(i+s)%this.framebufferHeight*this.framebufferWidth;this.ram[this.cpu.i+s]>>7-r&1&&(this.fb[a]?(this.fb[a]=0,this.cpu.v[15]=1):this.fb[a]=1)}}executeOp(e){const i=e>>12&15,t=e>>8&15,s=e>>4&15,r=e&4095,a=e&255,u=e&15,f={0:()=>{},224:()=>this.clearFramebuffer(),238:()=>{const c=this.cpu.r.pop();this.cpu.pc=c},255:()=>{this.hires=!0,this.clearFramebuffer()}};if(f[e]){f[e]();return}switch(i){case 1:this.cpu.pc=r;break;case 2:this.cpu.r.push(this.cpu.pc),this.cpu.pc=r;break;case 3:this.cpu.v[t]===a&&(this.cpu.pc+=2);break;case 4:this.cpu.v[t]!==a&&(this.cpu.pc+=2);break;case 5:this.cpu.v[t]===this.cpu.v[s]&&(this.cpu.pc+=2);break;case 9:this.cpu.v[t]!==this.cpu.v[s]&&(this.cpu.pc+=2);break;case 6:this.cpu.v[t]=a;break;case 7:this.cpu.v[t]=this.cpu.v[t]+a&255;break;case 8:{switch(u){case 0:this.cpu.v[t]=this.cpu.v[s];break;case 1:this.cpu.v[t]|=this.cpu.v[s];break;case 2:this.cpu.v[t]&=this.cpu.v[s];break;case 3:this.cpu.v[t]^=this.cpu.v[s];break;case 4:{const c=this.cpu.v[t]+this.cpu.v[s];this.cpu.v[t]=c&255,this.cpu.v[15]=c>255?1:0;break}case 5:{const c=this.cpu.v[t]-this.cpu.v[s],o=this.cpu.v[t]>=this.cpu.v[s];this.cpu.v[t]=c&255,this.cpu.v[15]=o?1:0;break}case 7:{const c=this.cpu.v[s]-this.cpu.v[t],o=this.cpu.v[s]>=this.cpu.v[t];this.cpu.v[t]=c&255,this.cpu.v[15]=o?1:0;break}case 6:{const c=this.cpu.v[s]>>1,o=this.cpu.v[s]&1;this.cpu.v[t]=c&255,this.cpu.v[15]=o?1:0;break}case 14:{const c=this.cpu.v[s]<<1,o=this.cpu.v[s]>>7&1;this.cpu.v[t]=c&255,this.cpu.v[15]=o?1:0;break}default:throw new Error(`Unknown instruction 0x${e.toString(16).padStart(4,"0")}`)}break}case 10:this.cpu.i=r;break;case 11:this.cpu.pc=r+this.cpu.v[0];break;case 12:this.cpu.v[t]=Math.random()*256&a;break;case 13:this.draw(this.cpu.v[t],this.cpu.v[s],u);break;case 14:{switch(a){case 158:this.k.has(this.cpu.v[t])&&(this.cpu.pc+=2);break;case 161:this.k.has(this.cpu.v[t])||(this.cpu.pc+=2);break;default:throw new Error(`Unknown instruction 0x${e.toString(16).padStart(4,"0")}`)}break}case 15:{switch(a){case 7:this.cpu.v[t]=this.cpu.dt;break;case 21:this.cpu.dt=this.cpu.v[t];break;case 24:this.cpu.st=this.cpu.v[t];break;case 10:this.waitReg=t,this.waitingInput=!0;break;case 30:this.cpu.i=this.cpu.i+this.cpu.v[t]&65535;break;case 41:this.cpu.i=(this.cpu.v[t]&15)*5;break;case 51:this.ram[this.cpu.i]=Math.floor(this.cpu.v[t]/100)%10,this.ram[this.cpu.i+1]=Math.floor(this.cpu.v[t]/10)%10,this.ram[this.cpu.i+2]=this.cpu.v[t]%10;break;case 85:for(let c=0;c<=t;c++)this.ram[this.cpu.i+c]=this.cpu.v[c];this.cpu.i=this.cpu.i+t+1&65535;break;case 101:for(let c=0;c<=t;c++)this.cpu.v[c]=this.ram[this.cpu.i+c];this.cpu.i=this.cpu.i+t+1&65535;break;case 117:for(let c=0;c<=t;c++)this.cpu.f[c]=this.cpu.v[c];break;case 133:for(let c=0;c<=t;c++)this.cpu.v[c]=255&this.cpu.f[c];break;default:throw new Error(`Unknown instruction 0x${e.toString(16).padStart(4,"0")}`)}break}default:throw new Error(`Unknown instruction 0x${e.toString(16).padStart(4,"0")}`)}}reset(){this.cpu={v:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pc:0,i:0,dt:0,st:0,r:[],f:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},this.ram=new Uint8Array(this.memSize),this.hires=!1,this.clearFramebuffer(),this.waitingInput=!1,this.k=new Set;for(let e=0;e<l.length;e++)this.ram[e]=l[e]}}class k{constructor(e){n(this,"ctx");this.canvas=e,this.ctx=e.getContext("2d");const i=()=>{const t=64*Math.floor(this.canvas.parentElement.offsetWidth/64),s=.5;this.canvas.width=Math.min(t,768),this.canvas.height=this.canvas.width*s};window.addEventListener("resize",i),i()}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}write(e,i,t){this.ctx.reset();const s=this.canvas.width/i;for(let r=0;r<i*t;r++){const a=Math.floor(r/i),u=r%i;e[r]&&(this.ctx.fillStyle="green",this.ctx.fillRect(u*s,a*s,s,s))}}}async function g(h){const e=await fetch(h);if(!e.ok)throw new Error(`Invalid response code: ${e.status}`);const i=await e.blob(),t=await new Promise((s,r)=>{const a=new FileReader;a.onload=u=>{var f;s((f=u.target)==null?void 0:f.result)},a.onerror=u=>{r(u)},a.readAsArrayBuffer(i)});return new Uint8Array(t)}async function y(){return new Promise((h,e)=>{let i=document.createElement("input");i.type="file",i.accept=".ch8",i.onchange=async t=>{const s=Array.from(i.files)[0];s?h({name:s.name,data:new Uint8Array(await s.arrayBuffer())}):e("No file uploaded")},i.click()})}const d=new k(document.getElementById("display")),p=new w,v={1:1,2:2,3:3,4:12,q:4,w:5,e:6,r:13,a:7,s:8,d:9,f:14,z:10,x:0,c:11,v:15};function x(h){d.clear(),d.write(h.framebuffer,h.framebufferWidth,h.framebufferHeight)}async function E(){let h=await g("ibm-logo.ch8");const e=()=>p.load(h);document.addEventListener("keydown",async t=>{const s=v[t.key];switch(s&&p.setKeyDown(s),t.key.toLowerCase()){case"o":h=(await y()).data,e();break;case"enter":e();break}}),document.addEventListener("keyup",t=>{const s=v[t.key];s&&p.setKeyUp(s)});const i=()=>{p.tick(),p.tick(),p.updateTimers(),x(p),setTimeout(i,0)};setTimeout(i,0),e()}E();
